{% extends "base.html" %}

{% block content %}

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    {% for item in trends %}
        <div class="bg-white rounded-lg shadow-md p-6 tr-conta tr-panel-{{ forloop.counter0 }}">
            <p class="text-white">{{ item.title }}</p>
            <h2 class="text-2xl font-bold text-white my-3">{{ item.data }}</h2>
            <span class="text-white text-xs inline-flex items-center">
            {% if item.delta > 0 %}
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-6 h-6 w-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
                </svg>
            {% elif item.delta == 0 %}
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-6 h-6 w-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" />
                </svg>
            {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-6 h-6 w-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6 9 12.75l4.286-4.286a11.948 11.948 0 0 1 4.306 6.43l.776 2.898m0 0 3.182-5.511m-3.182 5.51-5.511-3.181" />
                </svg>
            {% endif %}
            {{ item.delta|floatformat:2 }}% {{ item.moment }}
            </span>
        </div>
    {% endfor %}
</div>

<!-- Charts -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-md p-6 col-span-1">
        <h2 class="text-xl font-semibold mb-4">Platform Status</h2>
        <canvas id="platformStatusChart" class="w-full h-48"></canvas>
        <ul class="mt-4 space-y-2 text-sm text-gray-500">
            <li><span class="text-green-500 font-bold">•</span> RTSed</li>
            <li><span class="text-blue-500 font-bold">•</span> Development Phase</li>
        </ul>
    </div>

    <div class="relative bg-white rounded-lg shadow-md p-6 col-span-1">
        <h2 class="text-xl font-semibold mb-4">Image Released</h2>
        <canvas id="imageCatChart" class="w-full h-48"></canvas>
        <ul class="absolute bottom-4 space-y-2 text-sm text-gray-500">
            <li><span class="text-blue-500 font-bold">•</span> - Edge Image</li>
            <li><span class="text-red-500 font-bold">•</span> - Next Images</li>
            <li><span class="text-green-500 font-bold">•</span> - Proposed Images</li>
            <li><span class="text-purple-500 font-bold">•</span> - Production Images</li>
        </ul>
    </div>

    <div class="relative bg-white rounded-lg shadow-md p-6 col-span-1">
        <h2 class="text-xl font-semibold mb-4">Task Summary</h2>
        <canvas id="taskSummaryChart" class="w-full h-48"></canvas>
        <ul class="absolute bottom-4 space-y-2 text-sm text-gray-500">
            <li><span class="text-blue-500 font-bold">•</span> Count > 0 indicates task passed</li>
            <li><span class="text-red-500 font-bold">•</span> Count < 0 indicates task failed</li>
        </ul>
    </div>
</div>

<!-- Statistics -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-lg shadow-md p-6 col-span-2">
        <h2 class="text-xl font-semibold mb-4">Task Statistics</h2>
        <canvas id="taskCountChart" class="w-full h-48"></canvas>
        <p class="text-gray-500 text-sm mt-4">Task for this Week</p>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Recent Activity</h2>
        <ul class="space-y-4">
            {% for item in activity_list %}
            <li class="flex items-start">
                <div class="w-2 h-2 mt-2 flex items-center justify-center bg-green-400 rounded-full border-1">
                </div>
                <div class="ml-4">
                    <p class="regular-text text-black">{{ item.time }}</p>
                    <span class="text-sm text-grey-200 light-text">{{ item.user }}</span><span class="text-sm text-grey-400 regular-text ml-2">{{ item.detail }}</span>
                </div>
            </li>
            {% endfor %}
        </ul>
        <button class="text-blue-500 text-sm mt-4">Load More</button>
    </div>
</div>

{% endblock %}

{% block extra_js%}
<script>
    function renderDashboardTaskCountChart(){
        // chart for task count
        const taskCountCtx = document.getElementById('taskCountChart').getContext('2d');
        let taskCountChart;
    
        function renderTaskCountChart(){
            fetch("/api/charts_data/task_st_this_week")
            .then(response =>{
                if (!response.ok){
                    throw new Error('Charts data error')
                }
                return response.json();
            })
            .then(data => {
                console.log('retrive data success', data);
                taskCountData = data
                if (taskCountChart) {
                    taskCountChart.destory();
                }
    
                taskCountChart = new Chart(taskCountCtx, {
                    type: 'line',
                    data: {
                        labels: taskCountData['label'],
                        datasets: [{
                            label: 'Task Created: ',
                            data: taskCountData['dataset'],
                            borderColor: '#6366F1',
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { color: '#f1f5f9' }, beginAtZero: true }
                        }
                    }
                })

            })
            .catch(error => {
                console.error('retrive data error', error)
            });
        }
        renderTaskCountChart()
    }

    function renderDashboardImageReleasedChart(){
        //  chart for image release statistics
        const imgReleaseCtx = document.getElementById('imageCatChart').getContext('2d');
        let imageReleaseChart;
        function renderImageReleasedChart(){
            fetch("/api/charts_data/image")
            .then(response =>{
                if (!response.ok){
                    throw new Error('Charts data error')
                }
                return response.json();
            })
            .then(data => {
                console.log('retrive data success', data);
                imgReleaseData = data
                if (imageReleaseChart) {
                    imageReleaseChart.destory();
                }
    
                imageReleaseChart = new Chart(imgReleaseCtx, {
                    type: 'bar',
                    data: {
                        labels: imgReleaseData['label'],
                        datasets: [{
                            label: 'Edge',
                            data: imgReleaseData['dataset']['edge'],
                            backgroundColor: '#6366F1'
                        },
                        {
                            label: 'Next',
                            data: imgReleaseData['dataset']['next'],
                            backgroundColor: '#F87171'
                        },
                        {
                            label: 'Proposed',
                            data: imgReleaseData['dataset']['proposed'],
                            backgroundColor: '#34D399'
                        },
                        {
                            label: 'Production',
                            data: imgReleaseData['dataset']['production'],
                            backgroundColor: '#8B5CF6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { color: '#f1f5f9' }, beginAtZero: true }
                        }
                    }
                })
                
            })
            .catch(error => {
                console.error('retrive data error', error)
            });
        }
        renderImageReleasedChart()
    }

    function renderDashboardTaskSummaryChart(){
        // chart for task summary data
        const taskSumCtx = document.getElementById('taskSummaryChart').getContext('2d');
        let taskSumChart;
        function renderTaskSummaryChart(){
            fetch("/api/charts_data/task_result_sum")
            .then(response =>{
                if (!response.ok){
                    throw new Error('Charts data error')
                }
                return response.json();
            })
            .then(data => {
                console.log('retrive data success', data);
                tskSumChartData = data
                if (taskSumChart) {
                    taskSumChart.destory();
                }
    
                taskSumChart = new Chart(taskSumCtx, {
                    type: 'bar',
                    data: {
                        labels: tskSumChartData['label'],
                        datasets: [
                        {
                            label: 'Installation Passed',
                            data: tskSumChartData['dataset']['i']['pass'],
                            backgroundColor: ['#F87171']
                        },
                        {
                            label: 'Checkbox Passed',
                            data: tskSumChartData['dataset']['t']['pass'].map(num => -Math.abs(num)),
                            backgroundColor: ['#60A5FA']
                        },
                        {
                            label: 'Installation Failed',
                            data: tskSumChartData['dataset']['i']['fail'],
                            backgroundColor: ['#F87171']
                        },
                        {
                            label: 'Checkbox Failed',
                            data: tskSumChartData['dataset']['t']['fail'].map(num => -Math.abs(num)),
                            backgroundColor: ['#60A5FA']
                        },
                        ]
                    },
                    options: {
                        indexAxis: 'x',  // <-- This makes it horizontal
                        responsive: true,
                        plugins: {
                            legend: { display: false}
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                })
                
            })
            .catch(error => {
                console.error('retrive data error', error)
            });
        }
        renderTaskSummaryChart()
    }

    function renderDashboardPlatformStChart(){
        const platStCtx = document.getElementById('platformStatusChart').getContext('2d'); 
        new Chart(platStCtx, {
            type: 'doughnut',
            data: {
                labels: ['Development Phase', 'RTSed'],
                datasets: [{
                    data: [11, 25],
                    backgroundColor: ['#6366F1', '#34D399']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function renderChartsInDashboard(){
        renderDashboardTaskCountChart()
        renderDashboardImageReleasedChart()
        renderDashboardTaskSummaryChart()
        renderDashboardPlatformStChart()
    }

    document.addEventListener('DOMContentLoaded', function(){
        renderChartsInDashboard()
    });

</script>
{% endblock %}
